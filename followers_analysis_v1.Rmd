---
title: "followers_analysis_dim_reduction"
author: "Javier Fernandez"
date: "5/1/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, 
                      echo = TRUE, dpi = 300, cache.lazy = FALSE,
                      tidy = "styler", fig.width = 8, fig.height = 5)
library(knitr)
library(scales)
library(tidyverse)
library(here)
library(dplyr)
library(patchwork)
library(ggrepel)
library(directlabels)
library(ggbeeswarm)
library(ggjoy)
library(ggExtra)
library(funModeling)
library(purrr)
library(skimr)
library(sentimentr)
library(stringr) 
library(embed)
library(recipes)

```

## Loading data

```{r}
data <- read_csv(here('data','playlists_data.csv'))
#skim(data)
```

## Let's do a little exploration!

```{r}

data %>% 
  filter(owner=='spotify') %>% 
  ggplot(aes(monthly_owner_stream30s)) +
  geom_histogram()

data %>% 
  count(genre_1, 
        sort=TRUE)
data %>% 
  count(mood_1
        , sort=TRUE)



data %>% 
rowwise() %>%
  mutate(number_genres = sum(c_across(genre_1:genre_3) != "-"),
         number_moods =  sum(c_across(mood_1:mood_3) != "-")) %>%
  ungroup() %>%
  select(genre_1:genre_3, number_genres, mood_1:mood_3, number_moods ) %>%
  count(number_genres, sort = TRUE)

# Sentiment analysis
sentences <-  get_sentences(gsub('\\d|\U{FFFFFFFF}|\U3e33613c|\U3e63613c|\\[|\\]|\u00f1a', '',  enc2utf8(data$tokens)))
sentiments <- sentiment_by(sentences, list(data$playlist_uri, enc2utf8(data$tokens))) 

sentiments_idx <- sentiments %>% 
  rename(tokens_count = word_count) %>%
  select(-`tokens)`, -sd)

data_with_sentiment_score <-
inner_join(sentiments_idx, data, by='playlist_uri')


data_with_sentiment_score %>% 
  rowwise() %>%
  mutate(number_genres = sum(c_across(genre_1:genre_3) != "-"),
       number_moods =  sum(c_across(mood_1:mood_3) != "-")) %>%
  ungroup() 
  


  
```


```{r}
data %>% 
  mutate(monthly_stream30_followers=monthly_stream30s-monthly_owner_stream30s,
         mau_engagement=replace_na(mau_both_months*100/mau_previous_month,0),
         ratio_durable_streamings=replace_na(stream30s*100/streams,0)
         ) %>%
  filter(mau>3) %>%
  select(monthly_stream30_followers) %>% 
  ggplot(aes(x = factor(1), y = log10(monthly_stream30_followers)))+
  geom_boxplot(width = 0.4, fill = "white") +
  geom_jitter(width = 0.1, size = 1)
```

#Word Sentiment analysis
```{r}
data_sentiment <- data %>% 
  rowwise() %>%
  mutate(ratio_owner_streams = monthly_owner_stream30s/monthly_stream30s,
    number_genres = sum(c_across(genre_1:genre_3) != "-"),
       number_moods =  sum(c_across(mood_1:mood_3) != "-")) %>%
  ungroup() %>% 
  select(playlist_uri, monthly_stream30s, monthly_owner_stream30s, ratio_owner_streams, number_genres, number_moods,tokens) 


sentences <-  get_sentences(gsub('\\d|\U{FFFFFFFF}|\U3e33613c|\U3e63613c|\\[|\\]|\u00f1a', '',  enc2utf8(data_sentiment$tokens)))
sentiments <- sentiment_by(sentences, list(data_sentiment$playlist_uri, enc2utf8(data_sentiment$tokens))) 

sentiments_idx <- sentiments %>% 
  rename(tokens_count = word_count) %>%
  select(-`tokens)`, -sd)

data_cleaned <-
inner_join(sentiments_idx, data_sentiment, by='playlist_uri') %>% 
  mutate_if(is.character, factor)

data_cleaned  %>% 
  select(playlist_uri, tokens, ave_sentiment) %>% 
  arrange(desc(ave_sentiment)) %>% 
  tail(n=10) %>%
  arrange(ave_sentiment) %>%
  rename('Playlist ID' = playlist_uri,
         'Tokens' = tokens,
         'Avg. Sentiment Score'= ave_sentiment) %>%  View()
  

```


Let's do some local regressions with the sentiment scores



```{r}

#SAMPLEANDO 
set.seed(1)
df_sampled <- data_cleaned %>%
  sample_n(size=4118)


df_sampled %>% 
  ggplot(aes(x=ave_sentiment, y=monthly_owner_stream30s)) +
  geom_point(alpha = 0.8,size = 0.3, color='#20D760')+
  geom_smooth(method='loess',se=TRUE, color="#883149")+
  labs(y="Monthly Owner Streams >30s",
       x="Playlist Token Avg. Score") +
  theme_minimal() +
  theme(axis.text.x = element_text(family='Montserrat',face= "bold",size = 8),
        axis.text.y = element_text(family='Montserrat',face= "bold",size = 8),
         # Remove panel border
        panel.border = element_blank(),  
        # Remove panel grid lines
        #panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        # Remove panel background
        panel.background = element_blank(),
        # Add axis line
        axis.line = element_line(colour = "grey"),
        legend.position="none")+
  scale_y_continuous(limits = c(0, 400), breaks = seq(0, 400, by = 50))+
  scale_x_continuous(limits = c(-1.5,1.5))+
  ggsave(here('eda_graphs/',paste('owner_streamsVSsentiment_score','.png')),
               height = 4, 
               width = 5,
         device = "png")
```

# affecting the listeners
```{r}

df_sampled %>% 
  mutate(monthly_stream30_followers=monthly_stream30s-monthly_owner_stream30s) %>% 
  ggplot(aes(x=ave_sentiment, y=monthly_stream30_followers)) +
  geom_point(alpha = 0.8,size = 0.3, color='#20D760')+
  geom_smooth(method='loess',se=TRUE, color="#883149")+
  labs(y="Monthly Listeners Streams >30s",
       x="Playlist Token Avg. Score") +
  theme_minimal() +
  theme(axis.text.x = element_text(family='Montserrat',face= "bold",size = 8),
        axis.text.y = element_text(family='Montserrat',face= "bold",size = 8),
         # Remove panel border
        panel.border = element_blank(),  
        # Remove panel grid lines
        #panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        # Remove panel background
        panel.background = element_blank(),
        # Add axis line
        axis.line = element_line(colour = "grey"),
        legend.position="none")+
  scale_y_continuous(limits = c(0, 400), breaks = seq(0, 400, by = 50))+
  scale_x_continuous(limits = c(-1.5,1.5))+
  ggsave(here('eda_graphs/',paste('listeners_streamsVSsentiment_score','.png')),
               height = 4, 
               width = 5,
         device = "png")



```


#Visualizing lead genres and moods
```{r}
# Plot lead_genre
data %>% group_by(genre_1) %>% 
  summarise(count=n()) %>% 
  mutate(percent = count/sum(count)) %>% 
  arrange(percent, genre_1) %>% 
  mutate(genre_1=factor(genre_1, levels=genre_1)) %>%   # This trick update the factor levels
  ggplot(aes(x=percent, y=genre_1)) +
    geom_segment(aes(x=0, xend=percent, y=genre_1, yend=genre_1), color="#20D760") +
    geom_point(color = "#20D760")  +
    labs(x="Percentage of playlists", 
         y="Lead Genre") + 
    theme_minimal() +
    theme(axis.text.x = element_text(family='Montserrat',color='black',size = 8),
        axis.text.y = element_text(family='Montserrat',color='black',size = 8),
         # Remove panel border
        panel.border = element_blank(),  
        # Remove panel grid lines
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        # Remove panel background
        panel.background = element_blank(),
        # Add axis line
        axis.line = element_line(colour = "grey"),
        legend.position="none")+
        scale_x_continuous(expand = expansion(mult = c(0,0)),
                           limits=c(0,0.19),
                           labels = scales::percent_format(accuracy = 1L))+
        ggsave(here('eda_graphs/',paste0('lead_genre_ratio','.png')),
               height = 5, 
               width = 3,
         device = "png")
# Plot lead_mood
data %>% group_by(mood_1) %>% 
  summarise(count=n()) %>% 
  mutate(percent = count/sum(count)) %>% 
  arrange(percent, mood_1) %>% 
  mutate(mood_1=factor(mood_1, levels=mood_1)) %>%   # This trick update the factor levels
  ggplot(aes(x=percent, y=mood_1)) +
    geom_segment(aes(x=0, xend=percent, y=mood_1, yend=mood_1), color="#20D760") +
    geom_point(color = "#20D760")  +
    labs(x="Percentage of playlists", 
         y="Lead Mood") + 
    theme_minimal() +
    theme(axis.text.x = element_text(family='Montserrat',size = 8, color='black'),
        axis.text.y = element_text(family='Montserrat',size = 8,color='black'),
         # Remove panel border
        panel.border = element_blank(),  
        # Remove panel grid lines
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        # Remove panel background
        panel.background = element_blank(),
        # Add axis line
        axis.line = element_line(colour = "grey"),
        legend.position="none")+
        scale_x_continuous(expand = expansion(mult = c(0,0)),
                           limits=c(0,0.22),
                           labels = scales::percent_format(accuracy = 1L))+
        ggsave(here('eda_graphs/',paste0('lead_mood_ratio','.png')),
               height = 5, 
               width = 3,
         device = "png")



```

#Let's check the monthly streams from followers by mood and genre

```{r}
colourCount_genre_1 = length(unique(data_cleaned$genre_1))
colourCount_mood_1 = length(unique(data_cleaned$mood_1))

p1 <- data_cleaned %>% 
  mutate(monthly_stream30_followers=monthly_stream30s-monthly_owner_stream30s) %>% 
  select(monthly_stream30_followers, genre_1) %>% 
  ggbetweenstats(
  x = genre_1,
  y = monthly_stream30_followers,
  xlab = "Lead Genre", # label for the x-axis
  ylab = "Monthly Listeners Streams >30s", # label for the y-axis
  title = "",
  ggplot.component =
    # modify further with `ggplot2` functions
  list(
    scale_color_manual(values = paletteer::paletteer_c("ggthemes::Green-Blue Diverging",colourCount_genre_1)),
    theme(axis.text.x = element_text(angle = 90)))
  ) + 
  scale_y_continuous(limits = c(0,5000)) 

p2 <- data_cleaned %>% 
  mutate(monthly_stream30_followers=monthly_stream30s-monthly_owner_stream30s) %>% 
  select(monthly_stream30_followers, mood_1) %>% 
  ggbetweenstats(
  x = mood_1,
  y = monthly_stream30_followers,
  xlab = "Lead Mood", # label for the x-axis
  ylab = "Monthly Listeners Streams >30s", # label for the y-axis
  title = "",
  ggplot.component =
    # modify further with `ggplot2` functions
  list(
    scale_color_manual(values = paletteer::paletteer_c("ggthemes::Green-Blue Diverging",colourCount_mood_1)),
    theme(axis.text.x = element_text(angle = 90)))
  ) + 
  scale_y_continuous(limits = c(0,5000)) 

ggstatsplot::combine_plots(
  list(p1, p2),
  plotgrid.args = list(nrow = 2),
  annotation.args = list(
    title = "Distribution of the monthly listeners streams >30s across genre and mood categories"
  )
)+ ggsave(here('eda_graphs/',paste0('lead_mood_genre_monthlystreams_listenters','.png')),
               height = 10, 
               width = 15,
         device = "png")
 
 
  
  
  
```

  
```{r}
colourCount_genre_1 = length(unique(data$genre_1))
colourCount_mood_1 = length(unique(data$mood_1))

p1 <- data %>% 
  select(monthly_owner_stream30s, genre_1) %>% 
  ggbetweenstats(
  x = genre_1,
  y = monthly_owner_stream30s,
  xlab = "Lead Genre", # label for the x-axis
  ylab = "Monthly Owner Streams >30s", # label for the y-axis
  title = "",
  ggplot.component =
    # modify further with `ggplot2` functions
  list(
    scale_color_manual(values = paletteer::paletteer_c("ggthemes::Green-Blue Diverging",colourCount_genre_1)),
    theme(axis.text.x = element_text(angle = 90)))
  ) + 
  scale_y_continuous(limits = c(0,26000)) 

p2 <- data %>% 
select(monthly_owner_stream30s, mood_1) %>% 
  ggbetweenstats(
  x = mood_1,
  y = monthly_owner_stream30s,
  xlab = "Lead Mood", # label for the x-axis
  ylab = "Monthly Owner Streams >30s", # label for the y-axis
  title = "",
  ggplot.component =
    # modify further with `ggplot2` functions
  list(
    scale_color_manual(values = paletteer::paletteer_c("ggthemes::Green-Blue Diverging",colourCount_mood_1)),
    theme(axis.text.x = element_text(angle = 90)))
  ) + 
  scale_y_continuous(limits = c(0,26000)) 

ggstatsplot::combine_plots(
  list(p1, p2),
  plotgrid.args = list(nrow = 2),
  annotation.args = list(
    title = "Distribution of the monthly owner streams >30s across genre and mood categories"
  )
)+ ggsave(here('eda_graphs/',paste0('lead_mood_genre_monthlystreams_owners','.png')),
               height = 10, 
               width = 15,
         device = "png")
```
  
#Checking the monthly streams data points distributions

```{r}
data %>%
  mutate(monthly_stream30_followers=monthly_stream30s-monthly_owner_stream30s,
         creator = case_when(owner=='spotify' ~ 'Spotify',
                             owner!='spotify' ~ 'Independent User')) %>% 
select(creator, monthly_stream30_followers) %>% 
ggplot(aes(x=creator, y=monthly_stream30_followers))+
  geom_jitter(position = position_jitter(height = .2, width = .2), alpha = .7, colour='#20D760')+
  labs(x="", 
      y="") + 
  scale_y_continuous(name="Monthly Listeners Streams >30s", labels = scales::comma_format())+
  theme(axis.text.x = element_text(family='Montserrat',face= "bold",size = 8, color='black'),
        axis.text.y = element_text(family='Montserrat',face= "bold",size = 8, color='black'))+
  theme_minimal() +
  ggsave(here('eda_graphs/',paste0('monthly_jitter_creators','.png')),
               height = 6, 
               width = 4,
         device = "png")
  
```

#Feature Engineering: preparing the data
Let's work on Long Term Successes: MAU
```{r}
data_long_term <- data %>% 
  mutate(monthly_stream30_followers=monthly_stream30s-monthly_owner_stream30s,
         mau_engagement=replace_na(mau_both_months*100/mau_previous_month,0),
         owner_type = case_when(owner == 'spotify' ~ 'spotify',
                                TRUE ~ "created_by_user")
         ) %>%
  filter(mau>3,
         monthly_stream30_followers < 3*10^7) %>%
  rowwise() %>%
  mutate(number_genres = sum(c_across(genre_1:genre_3) != "-"),
       number_moods =  sum(c_across(mood_1:mood_3) != "-")) %>%
  ungroup() %>% 
  select(-genre_2,-genre_3,-mood_2, -mood_3, -monthly_stream30s, -monthly_owner_stream30s, n_local_tracks, -owner_country, -dau,-wau, -streams, -stream30s, -n_local_tracks)

sentences <-  get_sentences(gsub('\\d|\U{FFFFFFFF}|\U3e33613c|\U3e63613c|\\[|\\]|\u00f1a', '',  enc2utf8(data_long_term$tokens)))
sentiments <- sentiment_by(sentences, list(data_long_term$playlist_uri, enc2utf8(data_long_term$tokens))) 

sentiments_idx <- sentiments %>% 
  rename(tokens_count = word_count) %>%
  select(-`tokens)`, -sd)

data_cleaned <-
inner_join(sentiments_idx, data_long_term, by='playlist_uri') %>% 
  select(-tokens) %>% 
  mutate_if(is.character, factor)

#skim(data_cleaned)
  
  
```

#Local Regression with the number of genres
```{r}

#SAMPLEANDO 
set.seed(1234)
df_sampled <- data_cleaned %>%
  sample_n(size=3999)

data_cleaned %>% 
  # create ordered factor to allow synchronized order of x after as.numeric
  mutate(number_genres = factor(number_genres, ordered = T, c("0", "1", "2", "3")),
         monthly_stream30_followers=monthly_stream30s-monthly_owner_stream30s) %>% 
  ggplot(aes(x=number_genres, y=monthly_stream30_followers)) +
  geom_point(alpha = 0.8,size = 1, color='#20D760')+
  geom_smooth(aes(as.numeric(number_genres), monthly_stream30_followers), method = "loess", se=TRUE, color="#883149")+
  labs(y="Monthly Owner Streams >30s",
       x="Number of genres") +
  scale_y_continuous(limits = c(0,400)) +
  theme_minimal() +
  ggsave(here('eda_graphs/',paste0('nmr_genres_monthly_streams','.png')),
               height = 6, 
               width = 5,
         device = "png")



```

#ggbetweenstats for number of genres and number of moods

```{r}

library(ggstatsplot)


p1 <- data_cleaned %>% 
  mutate(number_genres = factor(number_genres, ordered = T, c("0", "1", "2", "3"))) %>% 
  ggbetweenstats(
  x = number_genres,
  y = monthly_stream30_followers,
  xlab = "Number of Genres", # label for the x-axis
  ylab = "Monthly Listeners Streams >30s", # label for the y-axis
  title = "",
  ggplot.component =
    # modify further with `ggplot2` functions
  list(scale_color_manual(values = paletteer::paletteer_c("ggthemes::Green-Blue Diverging",4)))) + 
  scale_y_continuous(limits = c(0,5000),
                     labels = scales::comma_format())

  
  p2 <- data_cleaned %>% 
  mutate(number_moods = factor(number_moods, ordered = T, c("0", "1", "2", "3"))) %>% 
  ggbetweenstats(
  x = number_moods,
  y = monthly_stream30_followers,
  xlab = "Number of Moods", # label for the x-axis
  ylab = "Monthly Listeners Streams >30s", # label for the y-axis
  title = "",
  ggplot.component =
    # modify further with `ggplot2` functions
  list(scale_color_manual(values = paletteer::paletteer_c("ggthemes::Green-Blue Diverging",4)))) + 
  scale_y_continuous(limits = c(0,5000),
                     labels = scales::comma_format())
  
  ggstatsplot::combine_plots(
    list(p1, p2),
    plotgrid.args = list(nrow = 1),
    annotation.args = list(
      title = ""
    )
  )+ ggsave(here('eda_graphs/',paste0('nmr_moods_genres_monthlystreams','.png')),
                 height = 8, 
                 width = 12,
           device = "png")
 


```

#scatterplots artists, tracks, albums
```{r}

##############################
# TRACKS
##############################

png(here('eda_graphs/',paste0('scatter_tracks_monthly_listeners','.png')), 
     width= 7, 
     height= 5, 
     units="in", 
     res=300)

data_cleaned %>% 
  ggscatterstats(
  x = n_tracks,
  y = monthly_stream30_followers,
  xlab = "Number of Tracks", # label for the x-axis
  ylab = "Monthly Listeners Streams >30s", # label for the y-axis
  title = "",
  marginal = FALSE,
  point.args = list(size = .7, 
                    alpha = 0.4, 
                    colour='#20D760'),
  smooth.line.args = list(size = 0.6, 
                          color = "#883149",
                          se=TRUE),
  ggplot.component = list( scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                                         labels = scales::trans_format("log10", scales::math_format(10^.x))),
                           scale_y_log10(limits = c(10^0,10^7),
                                         breaks = scales::trans_breaks("log10", function(x) 10^x),
                                         labels = scales::trans_format("log10", scales::math_format(10^.x))),
                                        annotation_logticks()))
  

# Close device
dev.off()

##############################
# Artists
##############################


png(here('eda_graphs/',paste0('scatter_artists_monthly_listeners','.png')), 
     width= 7, 
     height= 5, 
     units="in", 
     res=300)

data_cleaned %>% 
  ggscatterstats(
  x = n_artists,
  y = monthly_stream30_followers,
  xlab = "Number of Artists", # label for the x-axis
  ylab = "Monthly Listeners Streams >30s", # label for the y-axis
  title = "",
  marginal = FALSE,
  point.args = list(size = .7, 
                    alpha = 0.4, 
                    colour='#20D760'),
  smooth.line.args = list(size = 0.6, 
                          color = "#883149",
                          se=TRUE),
  ggplot.component = list( scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                                         labels = scales::trans_format("log10", scales::math_format(10^.x))),
                           scale_y_log10(limits = c(10^0,10^7),
                                         breaks = scales::trans_breaks("log10", function(x) 10^x),
                                         labels = scales::trans_format("log10", scales::math_format(10^.x))),
                                        annotation_logticks()))
  

# Close device
dev.off()


##############################
# Albums
##############################

png(here('eda_graphs/',paste0('scatter_albums_monthly_listeners','.png')), 
     width= 7, 
     height= 5, 
     units="in", 
     res=300)

data_cleaned %>% 
  ggscatterstats(
  x = n_albums,
  y = monthly_stream30_followers,
  xlab = "Number of Albums", # label for the x-axis
  ylab = "Monthly Listeners Streams >30s", # label for the y-axis
  title = "",
  marginal = FALSE,
  point.args = list(size = .7, 
                    alpha = 0.4, 
                    colour='#20D760'),
  smooth.line.args = list(size = 0.6, 
                          color = "#883149",
                          se=TRUE),
  ggplot.component = list( scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                                         labels = scales::trans_format("log10", scales::math_format(10^.x))),
                           scale_y_log10(limits = c(10^0,10^7),
                                         breaks = scales::trans_breaks("log10", function(x) 10^x),
                                         labels = scales::trans_format("log10", scales::math_format(10^.x))),
                                        annotation_logticks()))
   + ggsave(here('eda_graphs/',paste0('test_graph','.png')),
               height = 7, 
               width = 5,
         device = "png")
# Close device
dev.off()

##############################
# tokens count
##############################
png(here('eda_graphs/',paste0('scatter_tokens_monthly_listeners','.png')), 
     width= 7, 
     height= 5, 
     units="in", 
     res=300)

data_cleaned %>% 
  ggscatterstats(
  x = tokens_count,
  y = monthly_stream30_followers,
  xlab = "Number of Tokens", # label for the x-axis
  ylab = "Monthly Listeners Streams >30s", # label for the y-axis
  title = "",
  marginal = FALSE,
  point.args = list(size = .7, 
                    alpha = 0.4, 
                    colour='#20D760'),
  smooth.line.args = list(size = 0.6, 
                          color = "#883149",
                          se=TRUE),
  ggplot.component = list( scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                                         labels = scales::trans_format("log10", scales::math_format(10^.x))),
                           scale_y_log10(limits = c(10^0,10^7),
                                         breaks = scales::trans_breaks("log10", function(x) 10^x),
                                         labels = scales::trans_format("log10", scales::math_format(10^.x))),
                                        annotation_logticks()))
# Close device
dev.off()

```


#checking minthly streams per category genre and mood

```{r}
#SAMPLEANDO 
set.seed(1)
df_sampled <- data_cleaned %>%
  sample_n(size=3999)


colourCount_genre_1 = length(unique(df_sampled$genre_1))
colourCount_mood_1 = length(unique(data_cleaned$mood_1))

df_sampled %>% 
  select(monthly_stream30_followers, genre_1) %>% 
  group_by(genre_1) %>%
  summarise(max = max(monthly_stream30_followers, na.rm=TRUE),
            min= min(monthly_stream30_followers, na.rm=TRUE)) %>%  View()
    

data_cleaned %>% 
  select(monthly_stream30_followers, genre_1) %>% 
  ggbetweenstats(
  x = genre_1,
  y = monthly_stream30_followers,
  xlab = "Lead Genre", # label for the x-axis
  ylab = "Monthly Listeners Streams >30s", # label for the y-axis
  title = "",
  ggplot.component =
    # modify further with `ggplot2` functions
  list(
    scale_color_manual(values = paletteer::paletteer_c("ggthemes::Green-Blue Diverging",colourCount_genre_1)),
    theme(axis.text.x = element_text(angle = 0)))
  ) + 
  scale_y_continuous(limits = c(0,7500)) +
  scale_x_discrete(guide=guide_axis(n.dodge=2))+
  ggsave(here('eda_graphs/',paste0('lead_genre_monthlystreams_listenters','.png')),
               height = 8, 
               width = 12,
         device = "png")

data_cleaned %>% 
  select(monthly_stream30_followers, mood_1) %>% 
  ggbetweenstats(
  x = mood_1,
  y = monthly_stream30_followers,
  xlab = "Lead Mood", # label for the x-axis
  ylab = "Monthly Listeners Streams >30s", # label for the y-axis
  title = "",
  ggplot.component =
    # modify further with `ggplot2` functions
  list(
    scale_color_manual(values = paletteer::paletteer_c("ggthemes::Green-Blue Diverging",colourCount_mood_1)),
    theme(axis.text.x = element_text(angle = 0)))
  ) + 
  scale_y_continuous(limits = c(0,7500)) +
  scale_x_discrete(guide=guide_axis(n.dodge=2))+
  ggsave(here('eda_graphs/',paste0('lead_mood_monthlystreams_listenters','.png')),
               height = 8, 
               width = 12,
         device = "png")




  
  
  
```

```{r}
data_cleaned %>% 
 ggplot(aes(x=monthly_stream30_followers)) +
  aes(y=stat(count)/sum(stat(count))) + 
  geom_histogram(binwidth=50, boundary = 0, color="black", fill="#20D760")+
  scale_x_continuous(expand = expansion(mult = c(0,0)),
                     limits = c(-5,500), 
                     breaks = seq(0,500,50)
                     )+
  scale_y_continuous(labels = scales::percent)+
  labs(y = "Number of Playlists", 
       x="Monthly streams >30s of followers")+
  theme_minimal()+
  theme(
  axis.text.x = element_text(size = 8),
  axis.title.y = element_text(size = 10))

data_cleaned %>% 
  filter(monthly_stream30_followers>7000)%>%
  summarise(count_percent = (n()/102891)*100,
            n())

```



```{r}
library(embed)
library(recipes)

#data_super_cleaned <- data_cleaned %>% filter(monthly_stream30_followers>7000)

umap_rec <- recipe(~., data = data_cleaned) %>%
  update_role(playlist_uri, owner, new_role = "id") %>%
  step_corr(all_numeric()) %>%
  step_dummy(all_nominal(), -has_role("id")) %>%
  step_zv(all_numeric()) %>%
  step_normalize(all_predictors()) %>% 
  step_umap(all_predictors()) 

umap_prep <- prep(umap_rec)
  
umap_prep %>% juice()



bake(umap_prep, new_data = NULL) %>%
  ggplot(aes(umap_1, umap_2)) +
  geom_point(color = "midnightblue", alpha = 0.3, size = 0.5) +
 # geom_text(check_overlap = TRUE, hjust = "inward", family = "IBMPlexSans") +
  labs(color = NULL)
  


hdb <- bake(umap_prep, new_data = NULL) %>%
  select(umap_1, umap_2) %>% 
  hdbscan(minPts = 50)




# Modeling packages
library(mclust)   # for fitting clustering algorithms
# Apply GMM model with 3 components
data_mc <- Mclust(umap_prep %>% juice() %>% select(umap_1, umap_2), G = 7)

# Plot results
plot(data_mc, what = "density")
plot(data_mc, what = "uncertainty")

data_optimal_mc <- Mclust(umap_prep %>% juice() %>% select(umap_1, umap_2))
legend_args <- list(x = "bottomright", ncol = 5)
plot(data_optimal_mc, what = 'BIC', legendArgs = legend_args)
plot(data_optimal_mc, what = 'classification')
plot(data_optimal_mc, what = 'uncertainty')


data_optimal_mc %>% mutate(cluster=classification)

umap_prep %>% juice() %>% mutate(cluster=data_optimal_mc$classification,
                                 uncertainty=data_optimal_mc$uncertainty)



uncertainty <- data.frame(
  id = 1:nrow(umap_prep %>% juice()),
  cluster = data_optimal_mc$classification,
  uncertainty = data_optimal_mc$uncertainty
)

uncertainty %>%
  group_by(cluster) %>%
  filter(uncertainty > 0.25) %>%
  ggplot(aes(uncertainty, reorder(id, uncertainty))) +
  geom_point() +
  facet_wrap(~ cluster, scales = 'free_y', nrow = 1)


```



# Grid Search of parameters 
```{r}
n_neighbors <- c(15,30,50,100,150)
min_distance <- c( 0.001, 0.003, 0.009,0.03,0.09)
metrics <- c("euclidean" ,"cosine","hamming")

umap_rec <- recipe(~., data = data_cleaned) %>%
  update_role(playlist_uri, owner, new_role = "id") %>%
  step_corr(all_numeric()) %>%
  step_dummy(all_nominal(), -has_role("id")) %>%
  step_zv(all_numeric()) %>%
  step_normalize(all_predictors()) 
  




data_embs <- data_cleaned #copy of the data
for (nn in n_neighbors) {
 for (md in min_distance) {
  for (metr in metrics) {
    umap_prep <- umap_rec %>% step_umap(all_predictors(),
                           neighbors = nn,
                           min_dist = md,
                           options = list(metric = metr,
                                          verbose = TRUE, 
                                          n_threads = 1)) %>% prep()
     umap_embedding <- umap_prep %>% juice() 
  data_embs <- data_embs %>% 
  bind_cols(umap_embedding['umap_1'] %>% as_tibble() ) %>% 
  bind_cols(umap_embedding['umap_2'] %>% as_tibble() ) 
  names(data_embs)[names(data_embs) == 'umap_1' ] = paste('nn_',nn,'md_',md,'metric',metr,'1',sep = '.')
  names(data_embs)[names(data_embs) == 'umap_2' ] = paste('nn_',nn,'md_',md,'metric',metr,'2',sep = '.')
  }
 }
 
}



```


#Saving File

```{r}
write.csv(data_embs,here('data','playlists_embeds_trials.csv'), row.names = FALSE)
```


#Visualizing first example

```{r}

n_neighbors <- c(15,30,50,100,150)
min_distance <- c( 0.001, 0.003, 0.009,0.03,0.09)
metrics <- c("euclidean" ,"cosine","hamming")
for (nn in n_neighbors) {
 for (md in min_distance) {
  for (metr in metrics) {
data_embs %>%
 ggplot(aes(x = data_embs[[paste('nn_',nn,'md_',md,'metric',metr,'1',sep = '.')]], 
            y = data_embs[[paste('nn_',nn,'md_',md,'metric',metr,'2',sep = '.')]]
            ))+
 geom_point(size = 0.3,alpha =0.1) +
 labs(x = "UMAP 1", y = "UMAP 2" ,
    title = paste('UMAP Main Components: ', paste('nn_',nn,'md_',md,'metric',metr,sep = '.')))+
  theme_bw() +
   ggsave(here('umap_trials/',paste(paste('nn_',nn,'md_',md,'metric',metr,sep = '.'),'.png')),
               height = 7, 
               width = 8)
  }
 }
 
}
```



#Applying GMM for clustering!

```{r}
# Modeling packages
library(mclust)   # for fitting clustering algorithms
# Apply GMM model with 3 components
#data_mc <- Mclust(umap_prep %>% juice() %>% select(nn_.50.md_.0.09.metric.cosine.1, nn_.50.md_.0.09.metric.cosine.2), G = 7)

# Plot results
#plot(data_mc, what = "density")
#plot(data_mc, what = "uncertainty")

data_optimal_mc <- Mclust(data_embs %>% select(nn_.50.md_.0.09.metric.cosine.1, nn_.50.md_.0.09.metric.cosine.2))
legend_args <- list(x = "bottomright", ncol = 5)
plot(data_optimal_mc, what = 'BIC', legendArgs = legend_args)
plot(data_optimal_mc, what = 'classification', legendArgs = list(x = "bottomright"))
plot(data_optimal_mc, what = 'uncertainty')


data_optimal_mc %>% mutate(cluster=classification)

umap_prep %>% juice() %>% mutate(cluster=data_optimal_mc$classification,
                                 uncertainty=data_optimal_mc$uncertainty)
```




#Testing

```{r}
#Visualising with the name of the clusters
if(require("mclust")){
# Compute model-based-clustering 
require("mclust")

# Visualize classification
fviz_mclust(data_optimal_mc, "classification", geom = "point")
}

data_embs %>% select(nn_.50.md_.0.09.metric.cosine.1, nn_.50.md_.0.09.metric.cosine.2)

components <- data_optimal_mc$data %>%  as_tibble()%>% mutate(clust=as.factor(data_optimal_mc$classification),
                                 uncertainty=data_optimal_mc$uncertainty)
library("viridis")
components %>% ggplot(aes(x=nn_.50.md_.0.09.metric.cosine.1, 
                          y=nn_.50.md_.0.09.metric.cosine.2, 
                          color=ifelse(uncertainty < 30, clust,'gray'))) +
  geom_point(alpha=0.3)+
  scale_color_viridis(discrete = FALSE, option = "C")+
  theme_minimal()

ggplot(aes(x=var1,y=var2, color=ifelse(column_1 < 30, col_groups,'grey')))






```


```{r}

data_cleaned_clusterized <- data_cleaned  #copy of data

data_cleaned_clusterized <- data_cleaned_clusterized %>% 
  mutate(clust = as.factor(data_optimal_mc$classification),
         uncertainty = data_optimal_mc$uncertainty)
  

# Density plots cluster
data_cleaned_clusterized %>% 
  ggplot(aes(x=monthly_stream30_followers, y=clust, fill=clust))+
  geom_joy(scale = 2, alpha=0.5) +
  scale_y_discrete(expand=c(0.01, 0)) +
  scale_x_continuous(limits = c(0, 300))+
  labs(y=NULL,
       x=NULL) +
  theme_minimal()+
  theme(legend.position="none")

# Checking if there is any statistical differences between clusters
# Monthly streams >30s followers
library(ggstatsplot)
data_cleaned_clusterized %>% filter(uncertainty<30) %>% 
ggbetweenstats(
  x = clust,
  y = monthly_stream30_followers,
  title = "Distribution of the monthly_stream30_followers across clusters "
) + scale_y_continuous(limits = c(0,35000))
  
#owner type

library(RColorBrewer)
mycolors <- colorRampPalette(brewer.pal(9, "lancet"))(nb.cols)
# Owner type
data_cleaned_clusterized %>% filter(uncertainty<30) %>% 
ggbarstats(
  x = owner_type,
  y = clust,
  title = "Owner type by Cluster",
  xlab = "cluster",
  legend.title = "Owner type",
  ggplot.component = list(ggplot2::scale_x_discrete(guide = ggplot2::guide_axis(n.dodge = 2))),
  palette = "Paired"
)


library(WRS2) # for data
library(afex) # to run anova



library(scales)

#mau_engagement
data_cleaned_clusterized %>% 
  filter(uncertainty<0.3) %>% 
  mutate(mau_engagement_perc=mau_engagement/100) %>% 
ggbetweenstats(
  x = clust,
  y = mau_engagement_perc,
  title = "Distribution of the MAU_engagement across clusters ",
  palette = "Paired" 
) + scale_y_continuous(labels = scales::percent) +
   ggsave(here('data/exploratory','clusters_mau_engagement_certain.png'),
               height = 7, 
               width = 10)

#n_artists
data_cleaned_clusterized %>% 
  filter(uncertainty<0.3) %>% 
  ggbetweenstats(
  x = clust,
  y = n_artists,
  title = "Distribution of the #artists across clusters ",
  palette = "Paired" 
) + 
  scale_y_continuous(limits = c(0,4500)) +
   ggsave(here('data/exploratory','cluster_n_artists_certain.png'),
               height = 7, 
               width = 10)

#n_tracks
data_cleaned_clusterized %>% 
  filter(uncertainty<0.3) %>% 
  ggbetweenstats(
  x = clust,
  y = n_tracks,
  title = "Distribution of the #tracks across clusters ",
  palette = "Paired" 
) + 
  scale_y_continuous(limits = c(0,40000)) +
    ggsave(here('data/exploratory','cluster_n_tracks_certain.png'),
               height = 7, 
               width = 10)

#n_albums
data_cleaned_clusterized %>% 
  filter(uncertainty<0.3) %>% 
  ggbetweenstats(
  x = clust,
  y = n_albums,
  title = "Distribution of the #albums across clusters ",
  palette = "Paired" 
) + 
  scale_y_continuous(limits = c(0,4700)) + 
  ggsave(here('data/exploratory','cluster_n_albums_certain.png'),
               height = 7, 
               width = 10)

#users
data_cleaned_clusterized %>% 
  filter(uncertainty<0.3) %>% 
  ggbetweenstats(
  x = clust,
  y = users,
  title = "Distribution of the #users across clusters ",
  palette = "Paired" 
) + 
  scale_y_continuous(limits = c(0,121000)) + 
  ggsave(here('data/exploratory','cluster_users_certain.png'),
               height = 7, 
               width = 10)

#MAU
data_cleaned_clusterized %>% 
  filter(uncertainty<0.3) %>% 
  ggbetweenstats(
  x = clust,
  y = mau,
  title = "Distribution of the MAU across clusters ",
  palette = "Paired" 
) + 
  scale_y_continuous(limits = c(0,50000)) + 
  ggsave(here('data/exploratory','cluster_mau_certain.png'),
               height = 7, 
               width = 10)



#MAU previous month
data_cleaned_clusterized %>% 
  filter(uncertainty<0.3) %>% 
  ggbetweenstats(
  x = clust,
  y = mau_previous_month,
  title = "Distribution of the MAU previous month across clusters",
  palette = "Paired" 
) + 
  scale_y_continuous(limits = c(0,50000)) + 
  ggsave(here('data/exploratory','cluster_mau_prev_month_certain.png'),
               height = 7, 
               width = 10)


#number of tokens 
data_cleaned_clusterized %>% 
  filter(uncertainty<0.3) %>% 
  ggbetweenstats(
  x = clust,
  y = tokens_count,
  title = "Distribution of the #tokens across clusters",
  palette = "Paired" 
) + 
  scale_y_continuous(limits = c(0,50)) + 
  ggsave(here('data/exploratory','cluster_tokens_count_certain.png'),
               height = 7, 
               width = 10)

#number of skippers
data_cleaned_clusterized %>% 
  filter(uncertainty<0.3) %>% 
  ggbetweenstats(
  x = clust,
  y = skippers,
  title = "Distribution of the #skippers across clusters",
  palette = "Paired" 
) + 
  scale_y_continuous(limits = c(0,34200)) + 
  ggsave(here('data/exploratory','cluster_skippers_certain.png'),
               height = 7, 
               width = 10)

# AVE SENTIMENT
data_cleaned_clusterized %>% 
  filter(uncertainty<0.3) %>% 
  ggbetweenstats(
  x = clust,
  y = ave_sentiment,
  title = "Distribution of the avg sentiment across clusters",
  palette = "Paired" 
) + 
  scale_y_continuous(limits = c(-2.2,2.2)) + 
  ggsave(here('data/exploratory','cluster_avg_sentiment_certain.png'),
               height = 7, 
               width = 10)






data_genre_1 <- data_cleaned_clusterized %>% 
  filter(uncertainty<0.3) %>%
  group_by(clust, genre_1) %>% 
  summarise(count=n()) %>% 
  mutate(percent = count*100/sum(count)) %>% 
  arrange(clust, genre_1, percent) %>% View()
  




```




#Save important datasets

```{r}
write.csv(components,here('data','playlists_cleaned_mclust_optimal.csv'), row.names = FALSE)
write.csv(data_cleaned_clusterized,here('data','playlists_cleaned_clusterized.csv'), row.names = FALSE)


```


#Example circular barplot

```{r}
# Set a number of 'empty bar' to add at the end of each group
empty_bar <- 4
to_add <- data.frame( matrix(NA, empty_bar*nlevels(data_genre_1$clust), ncol(data_genre_1)) )
colnames(to_add) <- colnames(data_genre_1)
to_add$clust <- rep(levels(data_genre_1$clust), each=empty_bar)
data <- rbind(data_genre_1, to_add)
data <- data %>% arrange(clust)
data$id <- seq(1, nrow(data))
 
# Get the name and the y position of each label
label_data <- data
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust <- ifelse( angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)
 

# prepare a data frame for base lines
base_data <- data %>% 
  group_by(clust) %>% 
  summarise(start=min(id), 
            end=max(id) - empty_bar) %>% 
  rowwise() %>% 
  mutate(title=mean(c(start, end)))

  # prepare a data frame for grid (scales)
grid_data <- base_data
grid_data$end <- grid_data$end[ c( nrow(grid_data), 1:nrow(grid_data)-1)] + 1
grid_data$start <- grid_data$start - 1
grid_data <- grid_data[-1,]





# Make the plot
p <- ggplot(data, aes(x=as.factor(id), y=percent, fill=clust)) +       # Note that id is a factor. If x is numeric, there is some space between the first bar
  
  geom_bar(stat="identity", alpha=0.5) + 
 
  
  # Add a val=100/75/50/25 lines. I do it at the beginning to make sur barplots are OVER it.
  geom_segment(data=grid_data, aes(x = end, y = 80, xend = start, yend = 80), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 60, xend = start, yend = 60), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 40, xend = start, yend = 40), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 20, xend = start, yend = 20), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  
  # Add text showing the value of each 100/75/50/25 lines
  annotate("text", x = rep(max(data$id),4), y = c(20, 40, 60, 80), label = c("20", "40", "60", "80") , color="grey", size=3 , angle=0, fontface="bold", hjust=1) +
  
  geom_bar(stat="identity", alpha=0.5) +
  ylim(-100,120) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-1,4), "cm") 
  ) +
  coord_polar() + 
  geom_text(data=label_data, aes(x=id, y=percent+10, label=genre_1, hjust=hjust), color="black", fontface="bold",alpha=0.6, size=2.5, angle= label_data$angle, inherit.aes = FALSE ) +
  
  # Add base line information
  geom_segment(data=base_data, aes(x = start, y = -5, xend = end, yend = -5), colour = "black", alpha=0.8, size=0.6 , inherit.aes = FALSE )  +
  geom_text(data=base_data, aes(x = title, y = -18, label=clust), hjust=c(1,1,0,0), colour = "black", alpha=0.8, size=4, fontface="bold", inherit.aes = FALSE)
 
p
```



```{r}
library(ggplot2)
library(viridis)
library(tidyverse)

# Create dataset
data <- data.frame(
  individual=paste( "Mister ", seq(1,60), sep=""),
  group=c( rep('Group A', 10), rep('Group B', 30), rep('Group C', 14), rep('Group D', 6)) ,
  value=sample( seq(10,100), 60, replace=T), stringsAsFactors = TRUE) 


# Set a number of 'empty bar' to add at the end of each group
empty_bar <- 3
to_add <- data.frame( matrix(NA, empty_bar*nlevels(data$group), ncol(data)) )
colnames(to_add) <- colnames(data)
to_add$group <- rep(levels(data$group), each=empty_bar)
data <- rbind(data, to_add)
data <- data %>% arrange(group)
data$id <- seq(1, nrow(data))

# Get the name and the y position of each label
label_data <- data
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar 
label_data$hjust <- ifelse( angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)

# prepare a data frame for base lines
base_data <- data %>% 
  group_by(group) %>% 
  summarise(start=min(id), end=max(id) - empty_bar) %>% 
  rowwise() %>% 
  mutate(title=mean(c(start, end)))


angle <- 90 - 360 * (base_data$title-0.5)/number_of_bar  
base_data$angle <- ifelse(angle < -90, angle+180, angle)

# prepare a data frame for grid (scales)
grid_data <- base_data
grid_data$end <- grid_data$end[ c( nrow(grid_data), 1:nrow(grid_data)-1)] + 1
grid_data$start <- grid_data$start - 1
grid_data <- grid_data[-1,]

# Make the plot
ggplot(data, aes(x=as.factor(id), y=value, fill=group)) +       # Note that id is a factor. If x is numeric, there is some space between the first bar

  geom_bar(aes(x=as.factor(id), y=value, fill=group), stat="identity", alpha=0.5) +

# Add a val=100/75/50/25 lines. I do it at the beginning to make sur barplots are OVER it.
  geom_segment(data=grid_data, aes(x = end, y = 80, xend = start, yend = 80), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 60, xend = start, yend = 60), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 40, xend = start, yend = 40), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 20, xend = start, yend = 20), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +

  # Add text showing the value of each 100/75/50/25 lines
  annotate("text", x = rep(max(data$id),4), y = c(20, 40, 60, 80), label = c("20%", "40%", "60%", "80%") , color="grey", size=3 , angle=0, fontface="bold", hjust=1, vjust=0) +

  geom_bar(aes(x=as.factor(id), y=value, fill=group), stat="identity", alpha=0.5) +
  ylim(-50,120) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
#    plot.margin = unit(rep(-1,4), "cm") 
  ) +

  coord_polar() + 
  geom_text(data=label_data, aes(x=id, y=value+10, label=individual, hjust=hjust), color="black", fontface="bold",alpha=0.6, size=2.5, angle= label_data$angle, inherit.aes = FALSE ) +

# Add base line information
geom_segment(data=base_data, aes(x = start, y = -1, xend = end, yend = -1), colour = "black", alpha=0.6, size=0.8, inherit.aes = F ) +
geom_text(data=base_data, aes(x = title, y = -6, label=group, angle=angle), 
            hjust=c(1,1,0,0), colour = "black", alpha=0.7, size=2, fontface="bold", inherit.aes = FALSE)


```


#Genre_1

```{r}

data_genre_1 <- data_cleaned_clusterized %>% 
  filter(uncertainty<0.3) %>%
  group_by(clust, genre_1) %>% 
  summarise(count=n()) %>% 
  mutate(percent = count*100/sum(count)) %>% 
  filter(percent>0.05) %>% 
  arrange(clust, percent) 


# Set a number of 'empty bar' to add at the end of each group
empty_bar <- 3
to_add <- data.frame( matrix(NA, empty_bar*nlevels(data_genre_1$clust), ncol(data_genre_1)) )
colnames(to_add) <- colnames(data_genre_1)
to_add$clust <- rep(levels(data_genre_1$clust), each=empty_bar)
data <- rbind(data_genre_1, to_add)
data <- data %>% arrange(clust)
data$id <- seq(1, nrow(data))

# Get the name and the y position of each label
label_data <- data
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar 
label_data$hjust <- ifelse( angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)

# prepare a data frame for base lines
base_data <- data %>% 
  group_by(clust) %>% 
  summarise(start=min(id), end=max(id) - empty_bar) %>% 
  rowwise() %>% 
  mutate(title=mean(c(start, end)))



angle <- 90 - 360 * (base_data$title-0.5)/number_of_bar  
base_data$angle <- ifelse(angle < -90, angle+180, angle)


# prepare a data frame for grid (scales)
grid_data <- base_data
grid_data$end <- grid_data$end[ c( nrow(grid_data), 1:nrow(grid_data)-1)] + 1
grid_data$start <- grid_data$start - 1
grid_data <- grid_data[-1,]

# Make the plot
# Order data:


ggplot(data, aes(x=as.factor(id), y=value, fill=clust)) +       # Note that id is a factor. If x is numeric, there is some space between the first bar

  geom_bar(aes(x=as.factor(id), y=percent, fill=clust), stat="identity", alpha=0.5) +

# Add a val=100/75/50/25 lines. I do it at the beginning to make sur barplots are OVER it.
  geom_segment(data=grid_data, aes(x = end, y = 80, xend = start, yend = 80), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 60, xend = start, yend = 60), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 40, xend = start, yend = 40), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 20, xend = start, yend = 20), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +

  # Add text showing the percent of each 100/75/50/25 lines
  annotate("text", x = rep(max(data$id),4), y = c(20, 40, 60, 80), label = c("20%", "40%", "60%", "80%") , color="grey", size=3 , angle=0, fontface="bold", hjust=1, vjust=0) +

  geom_bar(aes(x=as.factor(id), y=percent, fill=clust), stat="identity", alpha=0.5) +
  ylim(-150, max(label_data$percent, na.rm=T)+10) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
#    plot.margin = unit(rep(-1,4), "cm") 
  ) +

  coord_polar() + 
  geom_text(data=label_data, aes(x=id, y=percent+10, label=genre_1), color="black", fontface="bold",alpha=0.6, size=3.5, angle= label_data$angle, hjust=label_data$hjust , inherit.aes = FALSE ) +

# Add base line information
geom_segment(data=base_data, aes(x = start, y = -1, xend = end, yend = -1), colour = "black", alpha=0.6, size=0.8, inherit.aes = F ) +
  
geom_text(data=base_data, aes(x = title, 
                              y = -6, 
                              label=c("cluster 1",
                                      "cluster 2",
                                      "cluster 3",
                                      "cluster 4",
                                      "cluster 5",
                                      "cluster 6",
                                      "cluster 7",
                                      "cluster 8",
                                      "cluster 9")), 
            hjust=c(0.25,1,1,1.25,0,0,0,0,0.7), vjust=c(1,1,1,0.24,0,0,0,0,1), colour = "black", alpha=0.7, size=4, fontface="bold", inherit.aes = FALSE)

```

# Mood_1
```{r}
data_mood_1 <- data_cleaned_clusterized %>% 
  filter(uncertainty<0.3) %>%
  group_by(clust, mood_1) %>% 
  summarise(count=n()) %>% 
  mutate(percent = count*100/sum(count)) %>% 
  filter(percent>0.05) %>% 
  arrange(clust, percent) 


# Set a number of 'empty bar' to add at the end of each group
empty_bar <- 3
to_add <- data.frame( matrix(NA, empty_bar*nlevels(data_mood_1$clust), ncol(data_mood_1)) )
colnames(to_add) <- colnames(data_mood_1)
to_add$clust <- rep(levels(data_mood_1$clust), each=empty_bar)
data <- rbind(data_mood_1, to_add)
data <- data %>% arrange(clust)
data$id <- seq(1, nrow(data))

# Get the name and the y position of each label
label_data <- data
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar 
label_data$hjust <- ifelse( angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)

# prepare a data frame for base lines
base_data <- data %>% 
  group_by(clust) %>% 
  summarise(start=min(id), end=max(id) - empty_bar) %>% 
  rowwise() %>% 
  mutate(title=mean(c(start, end)))



angle <- 90 - 360 * (base_data$title-0.5)/number_of_bar  
base_data$angle <- ifelse(angle < -90, angle+180, angle)


# prepare a data frame for grid (scales)
grid_data <- base_data
grid_data$end <- grid_data$end[ c( nrow(grid_data), 1:nrow(grid_data)-1)] + 1
grid_data$start <- grid_data$start - 1
grid_data <- grid_data[-1,]

# Make the plot
# Order data:


ggplot(data, aes(x=as.factor(id), y=value, fill=clust)) +       # Note that id is a factor. If x is numeric, there is some space between the first bar

  geom_bar(aes(x=as.factor(id), y=percent, fill=clust), stat="identity", alpha=0.5) +

# Add a val=100/75/50/25 lines. I do it at the beginning to make sur barplots are OVER it.
  geom_segment(data=grid_data, aes(x = end, y = 80, xend = start, yend = 80), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 60, xend = start, yend = 60), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 40, xend = start, yend = 40), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 20, xend = start, yend = 20), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +

  # Add text showing the percent of each 100/75/50/25 lines
  annotate("text", x = rep(max(data$id),4), y = c(20, 40, 60, 80), label = c("20%", "40%", "60%", "80%") , color="grey", size=3 , angle=0, fontface="bold", hjust=1, vjust=0) +

  geom_bar(aes(x=as.factor(id), y=percent, fill=clust), stat="identity", alpha=0.5) +
  ylim(-150, max(label_data$percent, na.rm=T)+10) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
#    plot.margin = unit(rep(-1,4), "cm") 
  ) +

  coord_polar() + 
  geom_text(data=label_data, aes(x=id, y=percent+10, label=mood_1), color="black", fontface="bold",alpha=0.6, size=3.5, angle= label_data$angle, hjust=label_data$hjust , inherit.aes = FALSE ) +

# Add base line information
geom_segment(data=base_data, aes(x = start, y = -1, xend = end, yend = -1), colour = "black", alpha=0.6, size=0.8, inherit.aes = F ) +
  
geom_text(data=base_data, aes(x = title, 
                              y = -6, 
                              label=c("cluster 1",
                                      "cluster 2",
                                      "cluster 3",
                                      "cluster 4",
                                      "cluster 5",
                                      "cluster 6",
                                      "cluster 7",
                                      "cluster 8",
                                      "cluster 9")), 
            hjust=c(0.25,1,1,0.7,0,0,0,0,0.7), vjust=c(1,1,1,0,0,0,0,0,1), colour = "black", alpha=0.7, size=4, fontface="bold", inherit.aes = FALSE)

```



